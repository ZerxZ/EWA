:: AvatarSetup [widget]
<<widget "SetAvatar">>

<<silently>>

<<if $charamaking is true>>
    <<setface $Equip.emote "loop">>
<</if>>
/* 相框 OR 特效 */
<<set $avatar.frame to setAvatar("frame",$PFace.frame)>>

/* 浴精喷精冒汗气息之类的 */
<<if $PFlag.bukkake.body is true>>
    <<set $avatar.addon.body to setAvatar("addon.body",true)>>
<<else>>
    <<set $avatar.addon.body to setAvatar("addon.body",false)>>
<</if>>

<<if $PFlag.bukkake.face is true>>
    <<set $avatar.addon.face to setAvatar("addon.face",true)>>
<<else>>
    <<set $avatar.addon.face to setAvatar("addon.face",false)>>
<</if>>

<<if $PFlag.bukkake.hair is true>>
    <<set $avatar.addon.hair to setAvatar("addon.hair",true)>>
<<else>>
    <<set $avatar.addon.hair to setAvatar("addon.hair",false)>>
<</if>>

<<if ($PC.rec.饮精.c gt 100)>>
    <<set $avatar.addon.face to setAvatar("addon.face",true)>>
<<else>>
    <<set $avatar.addon.face to setAvatar("addon.face",false)>>
<</if>>

<<if ($PC.rec.肛内射.c + $PC.rec.内射.c) gt 200 and $PFlag.bottom lte 1>>
    <<set $avatar.addon.bottom to setAvatar("addon.bottom",true)>>
<<else>>
    <<set $avatar.addon.bottom to setAvatar("addon.bottom",false)>>
<</if>>

<<if ($PC.rec.射精.c gt 10) and $PFlag.bottom lte 1>>
    <<set $avatar.addon.penis to setAvatar("addon.penis",true)>>
<<else>>
    <<set $avatar.addon.penis to setAvatar("addon.penis",false)>>
<</if>>


/* 共通处理 */
<<set _group to ["neck","hat","face","hand","bottom","inner_bt","shoes","legs","back"]>>

<<for _i to 0; _i lt _group.length; _i++ >>
<<set _n to _group[_i]>>
<<if $Equip[_n] isnot null and $Equip[_n].hasImg is true>>
   

    <<if $Equip[_n].fixcolor is true>>
        <<set $avatar[_n] to setAvatar(_n,{ fixcolor: true, color: $Equip[_n].color, src: $Equip[_n].index + "/" + $Equip[_n].color, acc: null,})>>
    <<else>>
        <<set $avatar[_n] to setAvatar(_n,{ fixcolor: false, color: $Equip[_n].color, src: $Equip[_n].index + "/basic", acc: null,})>>
    <</if>>
    <<if $Equip[_n].acc isnot null>>
        <<set $avatar[_n].acc to setAvatar(`${_n}.acc`,$Equip[_n].index + "/"+ $Equip[_n].acc) >>
    <</if>>
<<elseif $Equip[_n] isnot null and $Equip[_n].hasImg is false>>
    <<switch _n>>
        <<case "bottom">>
            <<set $avatar.bottom to setAvatar("bottom",{ fixcolor: true, color: "white", src: "shortpant/basic", acc: null, })>>
        <<case "inner_bt">>
            <<set $avatar.inner_bt to setAvatar("inner_bt",{ fixcolor: true, color: "white", src: "boxer/basic", acc: null, })>>
        <<default>>
            <<set $avatar[_n] to setAvatar(_n,{ fixcolor: true, color: "", src: null, acc: null, })>>
    <</switch>>
<<else>>
    <<set $avatar[_n] to setAvatar(_n,null)>>
<</if>>

<</for>>

/* 有胸部跟怀孕差分的上衣部分处理 */
<<set _group to ["outter","top","inner_up"]>>

<<for _i to 0; _i lt _group.length; _i++>>
<<set _n to _group[_i]>>

<<if $Equip[_n] isnot null and $Equip[_n].hasImg is true>>
    
    <<if $Equip[_n].fixcolor is true>>
        <<set $avatar[_n] to setAvatar(_n,{fixcolor:true, color: $Equip[_n].color, src: $Equip[_n].index + "/" + $Equip[_n].color, acc: null, tuckin:false})>>
    <<else>>
        <<set $avatar[_n] to setAvatar(_n,{fixcolor:false, color: $Equip[_n].color, src: $Equip[_n].index + "/basic" , acc: null, tuckin:false})>>
    <</if>>

    <<if $Equip[_n].tuckinable is true and $Equip[_n].tuckin is true>>
        <<set $avatar[_n].tuckin to setAvatar(`${_n}.tuckin`,true)>>
    <</if>>
    <<if $Equip[_n].acc isnot null>>
        <<set $avatar[_n].acc to setAvatar(`${_n}.acc`,$Equip[_n].index + "/"+ $Equip[_n].acc )>>
    <</if>>

    <<if $Equip[_n].hasDif.breast is true>>
        <<set $avatar[_n].src to setAvatar(`${_n}.src`,$avatar[_n].src + "_" + breastsize())>>
    <</if>>

    <<if $Equip[_n].hasDif.pregnant is true>>
        <<set $avatar[_n].src to setAvatar(`${_n}.src`,$avatar[_n].src + isPregnant())>>
    <</if>>

<<elseif $Equip[_n] isnot null and $Equip[_n].imagenable is false>>
    <<switch _n>>
        <<case "top">>
            <<set $avatar.top to setAvatar("top",{ fixcolor: true, color: "white", src: "Tshirt/white_" + breastsize() + isPregnant(), acc: "Tshirt/slime", tuckin:false })>>
        <<default>>
            <<set $avatar[_n] to setAvatar(_n,{ fixcolor: true, color: "", src: null, acc: null, })>>
    <</switch>>
<<else>>
    <<set $avatar[_n] to setAvatar(_n,null)>>
<</if>>

<</for>>

/* 眉毛 */
<<set $avatar.eyebrow to setAvatar("eyebrow",$PFace.eyebrow)>>


/* 发型前面 */
<<if Avatars.hairfront[$Equip.hairfront].fixcolor is true>>
    <<set $avatar.hairfront to setAvatar("hairfront",{fixcolor:true, color:null, src: $Equip.hairfront+"/"+$PC.info.haircolor+hasLength(Avatars.hairfront[$Equip.hairfront])})>>
<<else>>
    <<set $avatar.hairfront to setAvatar("hairfront",{fixcolor:false, color:A.haircolor[$PC.info.haircolor], src: $Equip.hairfront+"/basic"+hasLength(Avatars.hairfront[$Equip.hairfront])})>>
<</if>>

/* 发型后面 */
<<if Avatars.hairback[$Equip.hairback].fixcolor is true>>
    <<set $avatar.hairback to setAvatar("hairback",{fixcolor:true, color:null, src: $Equip.hairback+"/"+$PC.info.haircolor+hasLength(Avatars.hairback[$Equip.hairback])})>>
<<else>>
    <<set $avatar.hairback to setAvatar("hairback",{fixcolor:false, color:A.haircolor[$PC.info.haircolor], src: $Equip.hairback+"/basic"+hasLength(Avatars.hairback[$Equip.hairback])})>>
<</if>>


/* 兽耳、兽角、兽尾 */
/*
<<if $PC.trait.兽耳 is true>>
    <<set $avatar.kemofront.mimi to setAvatar("kemofront.mimi",{src= type/ + basic or color, color:=haircolor, fixcolor:true or false })>>
<</if>>

<<if $PC.trait.兽角 is true>>
    <<set $avatar.kemofront.horn to setAvatar("kemofront.horn",type )>>
<</if>>

<<if $PC.trait.翅膀 is true>>
    <<set $avatar.kemoback.wing  to setAvatar("kemoback.wing",{src= type/ + basic or color, color:=haircolor, fixcolor:true or false })>>
<</if>>

<<if $PC.trait.兽尾 is true>>
    <<set $avatar.kemoback.tail  to setAvatar("kemoback.tail",{src= type/ + basic or color, color:=haircolor, fixcolor:true or false })>>
<</if>>
 */

 /* 乳头/丁丁等特殊装备 */
<<if $Equip.penis isnot null>>
    <<set $avatar.penis to setAvatar("penis", $Equip.penis.png)>>
<<else>>
    <<set $avatar.penis to setAvatar("penis", null)>>
<</if>>

<<if $Equip.nipple isnot null>>
    <<if $Equip.nipple.breast is true>>
        <<set _path to $Equip.nipple.png + "_" + breastsize()>>
    <<else>>
        <<set _path to $Equip.nipple.png>>
    <</if>>
    <<set $avatar.nipple to setAvatar("nipple", _path)>>
<<else>>
    <<set $avatar.nipple to setAvatar("nipple", null)>>
<</if>>

<<if $Equip.anal isnot null and $Equip.anal.png isnot null>>
<<set $avatar.plus to setAvatar("plus", $Equip.anal.png)>>
<<else>>
<<set $avatar.plus to setAvatar("plus", null)>>
<</if>>

<<if $Equip.vagina isnot null and $Equip.vagina.png isnot null>>
<<set $avatar.plus to setAvatar("plus", $Equip.vagina.png)>>
<<else>>
<<set $avatar.plus to setAvatar("plus", null)>>
<</if>>


/* 眼睛 */
<<set _eyegroup to ["full","blink2","lookup3"]>>
<<set _type to [null,"a","b","c"]>>
<<set $avatar.eyes to setAvatar("eyes",$PC.info.eyecolor + "/" + $PFace.eyes)>>
<<if _eyegroup.includes($PFace.eyes) is true>>
    <<set $avatar.eyes to setAvatar("eyes",$avatar.eyes + _type[$PC.eyes])>>
<</if>>
<<if $PFace.eyes.includes("full") is true and $PFace.name is "正常">>
    <<set $avatar.eyes to setAvatar("eyes",$avatar.eyes + "_idle")>>
<</if>>

/* 嘴巴 */
<<set $avatar.mouth to setAvatar("mouth",$PFace.mouth)>>

/* 表情追加 */
<<set $avatar.emoadd.hurt to setAvatar("emoadd.hurt",$PFace.hurt)>>
<<set $avatar.emoadd.shy to setAvatar("emoadd.shy",$PFace.shy)>>
<<set $avatar.emoadd.tear to setAvatar("emoadd.tear",$PFace.tear)>>
<<set $avatar.emoadd.red to setAvatar("emoadd.red",$PFace.red)>>

<<if $PC.base.快感[0] gte ($PC.base.快感[1]/3) or $PC.state.发情 is true or $PC.base.酒精[0] gte ($PC.base.酒精[1]/2) or $PC.base.药物[0] gte 50>>
    <<set $avatar.emoadd.red to setAvatar("emoadd.red",true)>>
<</if>>

/* 淫纹 */
<<if $Pskin.腹部 isnot null>>
    <<set _apath to "./image/avatar/body/"+$Pskin.腹部.index+".png">>
    
    <<if ImgExist(_apath)>>
        <<set $avatar.tatoos to setAvatar("tatoos",$Pskin.腹部.index)>>
    <<else>>
        <<set $avatar.tatoos to setAvatar("tatoos","dummy")>>
    <</if>>
<<else>>
    <<set $avatar.tatoos to setAvatar("tatoos",null)>>
<</if>>

<<set _group to "羽族","兽族">>
/* 素体 */
<<if $PFlag.kemoform is true and _group.includes($PC.info.race)>>
    <<set $avatar.body to setAvatar("body", {src:"furry/body_"+ breastsize() + isPregnant(), color:A.haircolor[$PC.info.haircolor]})>>>>
        /* JJ，套上贞操笼时要变成软丁丁 */
    <<if $Equip.inner_bt isnot null and $Equip.inner_bt.index is "chastitycage">>
        <<set $avatar.dick to setAvatar("dick","furry/penis_d",true)>>
    <<else>>
        <<if $PC.genital.阴茎 gt 3 and $PFlag.bottom lte 1>>
            <<set $avatar.dick to setAvatar("dick","furry/penis",true)>>
        <<else>>
            <<set $avatar.dick to setAvatar("dick",null)>>
        <</if>>
    <</if>>
<<else>>
    <<set $avatar.body to setAvatar("body",$PC.info.skin +"/body_"+ breastsize() + isPregnant())>>
        /* JJ，套上贞操笼时要变成软丁丁 */
    <<if $Equip.inner_bt isnot null and $Equip.inner_bt.index is "chastitycage">>
            <<set $avatar.dick to setAvatar("dick",$PC.info.skin +"/penis_d",true)>>
    <<else>>
        <<if $PC.genital.阴茎 gt 3 and $PFlag.bottom lte 1>>
            <<set $avatar.dick to setAvatar("dick",$PC.info.skin +"/penis",true)>>
        <<else>>
            <<set $avatar.dick to setAvatar("dick",null)>>
        <</if>>
    <</if>>
<</if>>




/* 背景 */
<<set $avatar.background to setAvatar("background",imglocation())>>
<<if $avatar.background is "dummy">>
    <<set $avatar.background to setAvatar("background",null)>>
<</if>>

<</silently>>

<</widget>>

<<widget "checkimg">>
<<set _checkpath to "./image/avatar/"+$args[0]+"_"+$args[1]+"/"+$args[2]+".png">>

<<if ImgExist(_checkpath) is false>>
    <<if $args[3]>>
        <<set $avatar[$args[1]] to setAvatar($args[1],$args[3])>>
    <<else>>
         <<set $avatar[$args[1]] to setAvatar($args[1],"dummy")>>
    <</if>>
<</if>>

<</widget>>

:: ShowAvatar [widget]

<<widget "avatar">>
<<if $render is "canvas">>
    <<twinescript>>
    output.appendChild(Avatar.getCanvas())
    <</twinescript>>
<</if>>

<</widget>>

<<widget "portrait">>
<div id="portrait">

<<if $render is "canvas">>
    <div class="flipx">
    <<twinescript>>
    output.appendChild(Avatar.getPortrait())
    <</twinescript>>
    </div>
<</if>>

</div>
<</widget>>